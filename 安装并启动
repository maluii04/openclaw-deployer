#!/bin/bash

# OpenClaw Deployer - Mac ä¸€é”®å®‰è£…å¯åŠ¨è„šæœ¬
# è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£… Dockerï¼Œç„¶åå¯åŠ¨åº”ç”¨

set -e

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         OpenClaw Deployer - æ™ºèƒ½å®‰è£…å‘å¯¼                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# æ£€æµ‹æ¶æ„
ARCH=$(uname -m)
[ "$ARCH" = "arm64" ] && DOCKER_URL="https://desktop.docker.com/mac/main/arm64/Docker.dmg" \
                       || DOCKER_URL="https://desktop.docker.com/mac/main/amd64/Docker.dmg"

# ========== æ£€æŸ¥å¹¶å®‰è£… Docker ==========
echo "ğŸ” æ£€æŸ¥ Docker..."
if docker --version &>/dev/null; then
    echo -e "${GREEN}âœ“ Docker å·²å®‰è£…: $(docker --version 2>/dev/null | head -1)${NC}"
else
    echo -e "${YELLOW}âœ— Docker æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…...${NC}"
    echo ""
    echo "â¬‡ï¸  æ­£åœ¨ä¸‹è½½ Docker Desktopï¼ˆçº¦ 500MBï¼‰..."
    curl -L -o /tmp/Docker.dmg "$DOCKER_URL" --progress-bar || {
        echo -e "${RED}âœ— ä¸‹è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä» docker.com ä¸‹è½½${NC}"
        exit 1
    }
    
    echo "ğŸ“‚ æŒ‚è½½å®‰è£…é•œåƒ..."
    hdiutil attach /tmp/Docker.dmg -nobrowse -quiet
    
    echo "ğŸ“‹ å®‰è£… Docker Desktop..."
    cp -R "/Volumes/Docker/Docker.app" "/Applications/"
    
    echo "ğŸ”§ é…ç½® Docker..."
    hdiutil detach "/Volumes/Docker" -quiet 2>/dev/null || true
    rm -f /tmp/Docker.dmg
    
    echo -e "${GREEN}âœ“ Docker å®‰è£…å®Œæˆï¼${NC}"
    echo ""
    echo "âš ï¸  è¯·æ‰‹åŠ¨å¯åŠ¨ Docker Desktopï¼ˆåº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ä¸­ï¼‰"
    echo "   ç­‰å¾… Docker åˆå§‹åŒ–å®Œæˆåï¼Œé‡æ–°è¿è¡Œæœ¬è„šæœ¬"
    echo ""
    open "/Applications/Docker.app"
    read -p "Docker å¯åŠ¨å®Œæˆåï¼ŒæŒ‰å›è½¦é”®ç»§ç»­..."
fi
echo ""

# ========== æ£€æŸ¥ Git ==========
echo "ğŸ” æ£€æŸ¥ Git..."
if git --version &>/dev/null; then
    echo -e "${GREEN}âœ“ Git å·²å®‰è£…${NC}"
else
    echo -e "${YELLOW}âš ï¸  Git æœªå®‰è£…ï¼ˆå¯é€‰ï¼‰${NC}"
fi
echo ""

# ========== å¯åŠ¨åº”ç”¨ ==========
echo "ğŸš€ å¯åŠ¨ OpenClaw Deployer..."

# ä¼˜å…ˆæŸ¥æ‰¾åº”ç”¨
APP_PATH=""
for path in \
    "$SCRIPT_DIR/OpenClaw Deployer.app" \
    "$SCRIPT_DIR/openclaw-deployer.app" \
    "/Applications/OpenClaw Deployer.app"; do
    [ -d "$path" ] && APP_PATH="$path" && break
done

if [ -n "$APP_PATH" ]; then
    echo "   å¯åŠ¨åº”ç”¨: $APP_PATH"
    open "$APP_PATH"
else
    echo -e "${YELLOW}âš ï¸  æœªæ‰¾åˆ°åº”ç”¨ï¼Œä½¿ç”¨ Web ç‰ˆ...${NC}"
    open "https://2oskm4wkfd7fo.ok.kimi.link"
fi

echo ""
echo "âœ… å®Œæˆï¼"
echo ""
